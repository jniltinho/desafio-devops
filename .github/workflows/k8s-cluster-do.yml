## Create K8S Cluster DigitalOcean
name: "CREATE K8S CLUSTER DO"

on:
  push:
    branches:
      - infra
  workflow_dispatch:


env:
  DIGITALOCEAN_ACCESS_TOKEN: ${{secrets.DIGITALOCEAN_ACCESS_TOKEN}}
  TZ: 'America/Sao_Paulo'


jobs:
  k8s-cluster-do:
    runs-on: ubuntu-latest
    container:
      image: jniltinho/deploy-debian-k8s:latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    # Checks that all Terraform configuration files adhere to a canonical format
    - name: Terraform Format
      run: cd infra/k8s-cluster-do/; terraform fmt -check
    - name: Terraform Init
      run: cd infra/k8s-cluster-do/; terraform init

    # Generates an execution plan for Terraform
    - name: Terraform Validate
      run: cd infra/k8s-cluster-do/; terraform validate

    # Create k8s Cluster DigitalOcean
    - name: Create Cluster DO
      run: cd infra/k8s-cluster-do/; terraform apply --auto-approve
      
    - name: Add K8s Config for kubectl
      run: doctl kubernetes cluster list; doctl kubernetes cluster kubeconfig save cluster01      
      
    - name: Install NGINX Ingress Controller
      run: | 
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.44.0/deploy/static/provider/cloud/deploy.yaml
        kubectl get pods --all-namespaces -l app.kubernetes.io/name=ingress-nginx
        kubectl get pods --all-namespaces -l app.kubernetes.io/name=ingress-nginx
        kubectl get services ingress-nginx-controller --namespace=ingress-nginx
        kubectl get services ingress-nginx-controller --namespace=ingress-nginx
      
      
      
     
      
